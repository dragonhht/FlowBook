<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>用户界面</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <script th:src="@{/js/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <link rel="stylesheet" th:href="@{/css/user.css}" />
    <script th:src="@{/js/user.js}" ></script>
</head>
<body>
<!--顶部-->
<div class="top_logo">
        <span class="logo_img">
            <img th:src="@{/img/flowbook1.png}" />
        </span>
    <ul id="top_ul">
        <li>
            <th:block th:if="${session.user eq null}">
                <a th:href="@{/login}" onclick="selectNav(this)">登录</a> |
                <a th:href="@{/register}" onclick="selectNav(this)">注册</a>
            </th:block>
            <th:block th:unless="${session.user eq null}">
                <a th:href="@{/user/userHome}" onclick="selectNav(this)" th:text="${session.user.getUserName()}"></a> |
                <a th:href="@{/user/logout}" onclick="selectNav(this)">注销</a>
            </th:block>

        </li>
        <li><a href="#" onclick="selectNav(this)">活动</a></li>
        <li><a th:href="@{/notice}" onclick="selectNav(this)">公告</a></li>
        <li><a th:href="@{/index}" onclick="selectNav(this)" style="color: gray;">首页</a></li>
    </ul>
</div>

    <!--页面中部-->
    <div class="center_bg">
        <div class="center_search" id="center_search">
            <form class="form-inline" action="#" method="post">
                <ul class="nav nav-tabs" id="search_ul" style="width: 500px">
                    <li class="active" onclick="selectSearchType(this)"><a>书名</a></li>
                    <li onclick="selectSearchType(this)"><a>作者</a></li>
                    <li onclick="selectSearchType(this)"><a>出版社</a></li>
                    <li onclick="selectSearchType(this)"><a>用户</a></li>
                </ul>
                <div class="search_input_div">
                    <input type="text" hidden="hidden" value="书名" id="search_flag" />
                    <input type="text" class="search_input" placeholder="请输入您要搜索的内容" />
                    <button type="submit" class="btn btn-lg btn-warning">搜索</button>
                </div>
            </form>
        </div>

        <div class="center_user">
            <div class="user_img">
                <img class="img-thumbnail" th:src="@{${user.userImg}}" />
            </div>
            <div class="user_message">
                <div class="user_message_name" th:text="${user.userName}"></div>
                <div class="user_credit user_message_message">
                    <label>用户信用：</label>
                    <div>星级显示</div>
                </div>

                <div class="user_region user_message_message">
                    <label>地区：</label>
                    <span>江西</span>
                </div>

                <div class="add_user">
                    <a onclick="return loginTip();" th:unless="${isAdd}">
                        <input id="friendId" hidden="hidden" th:value="${user.userId}" />
                        <img th:src="@{/img/adduser.png}" />
                            加为好友
                    </a>
                    <a onclick="return chatLoginTip();" >
                        <img th:src="@{/img/chat.png}" />
                        联系
                    </a>
                    <a >
                        <img style="width: 15px;height: 15px" th:src="@{/img/report.png}" />
                        举报
                    </a>
                </div>
            </div>
        </div>

        <div class="tabs_div">
            <ul class="nav nav-tabs" id="nav_tabs">
                <li class="active" index="0" onclick="selectTab(this)"><a>贡献书籍</a></li>
                <li index="1" onclick="selectTab(this)"><a>借阅记录</a></li>
                <li index="2" onclick="selectTab(this)"><a>发布的公告</a></li>
            </ul>
            <!--贡献书籍表-->
            <table id="contribution" class="table table-striped">
                <tr>
                    <td>编号</td>
                    <td>书名</td>
                    <td>作者</td>
                    <td>出版社</td>
                    <td>日期</td>
                </tr>
                <tr th:each="book : ${user.contribution}">
                    <td th:text="${book.bookId}"></td>
                    <td th:text="${book.bookName}"></td>
                    <td th:text="${book.author}"></td>
                    <td th:text="${book.publish}"></td>
                    <td th:text="${book.bookDate}"></td>
                </tr>
            </table>

            <!--借阅图书-->
            <table id="borrow" class="table table-striped" hidden="hidden">
                <tr>
                    <td>编号</td>
                    <td>书名</td>
                    <td>作者</td>
                    <td>出版社</td>
                    <td>日期</td>
                </tr>
                <tr th:each="record : ${records}">
                    <td th:text="${record.book.bookId}"></td>
                    <td th:text="${record.book.bookName}"></td>
                    <td th:text="${record.book.author}"></td>
                    <td th:text="${record.book.publish}"></td>
                    <td th:text="${record.recordDate}"></td>
                </tr>
            </table>

            <!--发布公告-->
            <table id="notice" class="table table-striped" hidden="hidden">
                <tr>
                    <td>公告信息</td>
                    <td>日期</td>
                </tr>
                <tr th:each="notice : ${user.notices}">
                    <td th:text="${notice.noticeText}"></td>
                    <td th:text="${notice.noticeDate}"></td>
                </tr>
            </table>
        </div>

    </div>

    <!--底部-->
    <div class="footer" align="center">
        <p class="copyright">
            Copyright © 2017. All Rights Reserved by dragonhht from
            <a href="https://github.com/dragonhht" title="Github" target="_blank" style="color: gray;">dragonhht</a>
        </p>
    </div>
</body>

<!--好友添加结果-->
<div  class="result" id="result" hidden="hidden" >
    <span class="close" onclick="hideUpdateDiv(this)">x</span>
    <span id="message" class="text"></span>
</div>

<!--联系聊天框-->
<div class="chat" id="chat" hidden="hidden">
    <div class="friend_name" id="chatWithName" align="center" th:text="${user.userName}"></div>
    <span class="close" onclick="closeChat()">x</span>

    <div id="chat_div" class="chat_div">
        <input hidden="hidden" type="text" id="chatWithId" th:value="${user.userId}" />
        <div class="speak_box">

        </div>

    </div>
    <div class="input_div">
        <textarea id="msg" onKeyUp="keyup()"></textarea>
        <button onClick="up_say()" class="btn btn-info">发送</button>
    </div>
</div>

<script type="text/javascript" th:inline="javascript">
    /** 添加好友. */
    function addFriend() {
        var friendId = $('#friendId').val();
        var toUrl = [[@{/user/addFriend}]];
        $.post(toUrl,
            {
                friend : friendId
            },
        function (data) {
            if (data) {
                $('#message').html('添加好友成功');
            } else {
                $('#message').html('添加好友失败');
            }
            $('#result').show();
        })
    }
    
    function hideUpdateDiv() {
        $('#result').hide();
    }

    $(document).click(function () {
        $('#result').hide();
    });

    $("#result").click(function(event){
        event.stopPropagation();
    });

    //添加判断是否登录
    function loginTip() {
        var user = [[${session.user.userId}]];
        if (user == null) {
            if (window.confirm("请先登录!")) {
                window.location.replace("../../login");
                return false;
            } else {
                return false;
            }
        } else {
            addFriend();
            return true;
        }
    }


    var str;

    function showMyMssage(text) {
        str = '<div class="question">';
        str += '<div class="heard_img right"><img th:src="@{${session.user.userImg}}"/></div>';
        str += '<div class="question_text clear"><p>'+text+'</p><i></i>';
        str += '</div></div>';
        $('.speak_box').append(str);
    }

    function up_say(){
        $('.write_list').remove();
        var text = $('.input_div textarea').val();

        if(text == ''){
            alert('请输入内容！');
            $('.input_div textarea').focus();
        }else{

            sendMessage();

            showMyMssage(text);
            $('.input_div textarea').val('');
            $('.input_div textarea').focus();
            autoWidth();
            for_bottom();

        }
    }

    function keyup(){
        var footer_height = $('.wenwen-footer').outerHeight(),
            text = $('.write_box input').val(),
            str = '<div class="write_list">'+text+'</div>';
        if (text == '' || text == undefined){
            $('.write_list').remove();
        }else{
            $('.wenwen-footer').append(str);
            $('.write_list').css('bottom',footer_height);
        }
    }

    // 显示他人信息
    function showMessage(text){
        var ans  = '<div class="answer"><div class="heard_img left"><img src="images/dglvyou.jpg" /></div>';
        ans += '<div class="answer_text"><p>'+ text + '</p><i></i>';
        ans += '</div></div>';
        $('.speak_box').append(ans);
        for_bottom();
    }

    function for_bottom(){
        var speak_height = $('.speak_box').height();
        $('.speak_box').animate({scrollTop:speak_height},500);
        scrollToBottom();
    }

    function autoWidth(){
        $('.question_text').css('max-width',$('.question').width()-60);
    }
    autoWidth();

    var ws = null;

    /** 联系判断用户是否登录. */
    function chatLoginTip() {
        var user = [[${session.user.userId}]];
        if (user == null) {
            if (window.confirm("请先登录!")) {
                window.location.replace("../../login");
                return false;
            } else {
                return false;
            }
        } else {
            console.log('联系');
            $('#chat').show();
            $('#chat').focus();
            ws = new WebSocket("ws://localhost:8080/FlowBook/webSocketHandler");
            ws.onopen = function () {
                console.log("onpen");
                ws.send("{}");
            };
            chatWith();
            return true;
        }
    }

    function closeChat() {
            console.log('消失');
            ws.onclose = function () {
                console.log("onclose");
            };
            $('#chat').hide();
    };

    ws.onmessage = function (msg) {
        var message = msg.data;
        message = message.split("/[-=^*]");
        var chatWithId = $('#chatWithId').val().trim();
        if (chatWithId == message[0].trim()) {
            showMessage(message[1]);
        }
    };

    function sendMessage() {
        var text = $('.input_div textarea').val();
        var to = $('#chatWithId').val();
        $.post('../../message',
            {
                message : text,
                userId : to
            },
            function (data) {
                console.log("data:" + data);
            })
    }

    function chatWith(n) {
        $('.speak_box').html("");
        var friendId = $('#chatWithId').val();
        getFriendMsg(friendId);
    }

    /*<![CDATA[*/
    function getFriendMsg(friendId) {
        $.post('../../chatWith',
            {
                friendId : friendId
            },
            function (data) {
                console.log(data);
                var friendMsg = data.friendMsg;
                var selfMsg = data.selfMsg;
                var friendLenght = friendMsg.length;
                var selfLenght = selfMsg.length;
                var i = 0, j = 0;
                while (i < friendLenght && j < selfLenght) {
                    if (friendMsg[i].date < selfMsg[j].date) {
                        showMessage(friendMsg[i].message);
                        console.log("friend : " + friendMsg[i].date);
                        i++;
                    } else {
                        showMyMssage(selfMsg[j].message);
                        console.log("self : " + selfMsg[j].date);
                        j++;
                    }
                }
                console.log(i + ' : ' + j);

                for ( ; i < friendLenght; i++) {
                    showMessage(friendMsg[i].message);
                }
                for ( ; j < selfLenght; j++) {
                    showMyMssage(selfMsg[j].message);
                }

                console.log(i + ' : ' + j);
            });
    }
    /*]]>*/
    
    function scrollToBottom() {
        var h = $('.speak_box').height();
        console.log("高度： " + h);
        // $('.speak_box').scrollTop(h);
        $('#chat_div').animate({
                scrollTop: h
            },
            500);
    }


</script>

</html>